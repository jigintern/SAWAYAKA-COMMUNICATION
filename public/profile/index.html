<!DOCTYPE html>
<html lang="ja">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/styles/components.css">
  <link rel="stylesheet" href="/styles/profile.css">
  <link href="https://use.fontawesome.com/releases/v62.0/css/all.css" rel="stylesheet">
  <script src="/lib/sessionChecker.js"></script>
  <!-- Link Swiper's CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

  <style>
    .swiper {
      width: 70%;
      height: calc(100svh - 35rem);
      min-height: 17rem;
      filter: drop-shadow(.1rem .1rem .3rem gray);
    }

    .swiper-slide {
      display: flex;
      position: relative;
      align-items: center;
      justify-content: center;
      border-radius: 1.2rem;
      padding: 1.75rem;
      font-size: 1.45rem;
      font-weight: bold;
      background-color: #a6f3f1;
      background-image: linear-gradient(0deg,
          #aef4f1,
          #a6f3f1);
      color: rgb(23, 61, 86);
      flex-direction: column;
    }

    .swiper-slide>* {
      position: relative;
      z-index: 20;
    }

    .datebox {
      font-size: small;
      color: rgb(46, 46, 46);
    }

    .leaf_over {
      position: absolute;
      width: 10rem;
      height: 10rem;
      fill: rgb(168, 233, 230);
      z-index: 15;
      transform: translateY(-.7rem);
    }
  </style>
  <title>profile_page</title>
</head>

<body>
  <div id="notification"></div>
  <div id="header"></div>
  <main>
    <!--ユーザー情報表示カード-->
    <div id="user_content_card">
      <div id="user_header_area">
        <!-- <div id="user_name">
          <p id="user_nick_name">User_Nick_Name</p>
        </div> -->
      </div>
      <div class="user_data">
        <div id="user_icon_wrapper">
          <div id="user_icon">
            <div id="user_tmp_img">
              <svg id="svg_x5F_leaf" style="width: 60%; transform:translateX(-.2rem)" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 747.35 877.82">
                <!-- Leaf -->
                <path class="svg_x5F_leaf_path" style="fill: rgb(30, 172, 118);"
                  d="M0,873.85c1.36.25,19.03,3.97,49.48,3.97,18.09,0,39.61-1.31,62.51-5.45,36.32-6.57,68.51-18.93,95.68-36.74,33.9-22.23,59.92-52.96,77.38-91.35,87.24,48.42,186.2,13.76,202.67,7.99,164.25-57.55,218.73-252.15,237.35-318.69,54.46-194.56-4.33-363.59-33.76-433.58,7.19,58.78-103.84,112.64-207.37,166.96-103.53,54.32-273.61,83.83-306.88,281.09-15.62,92.62,2.35,210.16,76.69,274.37,18.08-152.57,202.81-316.97,202.81-316.97,0,0-112.46,168.42-186.14,329.81l-3.04,6.64c-29.76,61.72-82.85,99.94-157.92,113.64-58.45,10.67-108.96,1.67-109.46,1.58v16.73Z" />
              </svg>
            </div>
          </div>
        </div>
        <!-- <div id="SPoint">
          <p><b>500 SP</b></p>
        </div> -->
        <div id="user_info_area">
          <span id="user_id">ID:<span id="user_id_blank"></span></span>
          <span id="user_QR_code"><img src="/icons/QR-code.svg" alt=""></span>
        </div>
      </div>
      <div class="user_grade">
        <div class="grade_text">👑<span id="user_grade_name_blank"></span></div>
        <div class="progress">
          <span id="user_grade" class=""></span>
        </div>
      </div>
      <!--ユーザー趣味表示部分-->
      <div id="user_hobby_card">
        <div id="hobby_category">
          <p>カテゴリー「<span id="user_hobby_blank"></span>」</p>
        </div>
        <div id="hobby_content">
          <p><span id="user_hobby_content_blank"></span></p>
        </div>
      </div>
    </div>

    <div id="Show_SPoint">
      <div class="swiper mySwiper">
        <div class="swiper-wrapper" id="show_SPoints">
          <div class="swiper-slide">
            <p>左右にスワイプしよう！</p>
            <div class=leaf_over>
              <svg id="svg_x5F_leaf" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 747.35 877.82">
                <path class="svg_x5F_leaf_path"
                  d="M0,873.85c1.36.25,19.03,3.97,49.48,3.97,18.09,0,39.61-1.31,62.51-5.45,36.32-6.57,68.51-18.93,95.68-36.74,33.9-22.23,59.92-52.96,77.38-91.35,87.24,48.42,186.2,13.76,202.67,7.99,164.25-57.55,218.73-252.15,237.35-318.69,54.46-194.56-4.33-363.59-33.76-433.58,7.19,58.78-103.84,112.64-207.37,166.96-103.53,54.32-273.61,83.83-306.88,281.09-15.62,92.62,2.35,210.16,76.69,274.37,18.08-152.57,202.81-316.97,202.81-316.97,0,0-112.46,168.42-186.14,329.81l-3.04,6.64c-29.76,61.72-82.85,99.94-157.92,113.64-58.45,10.67-108.96,1.67-109.46,1.58v16.73Z" />
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div id="footer"></div>

  <script>
    window.onload = async (event) => {
      url = new URL(location.href)

      const current_user_profile = await JSON.parse(localStorage.getItem("current_user"));
      console.log(current_user_profile)

      const id = url.searchParams.get("id") ?? current_user_profile.id

      const userResponse = await fetch(`/user?id=${id}`, {
        method: "GET",
      }).then(res => res.json())
      console.log(userResponse)

      const response = await fetch(`/sp?id=${id}`);
      const data = await response.json();

      console.log(data);
      await displayList(data);

      var swiper = new Swiper(".mySwiper", {
        effect: "cards",
        grabCursor: true,
      });

      const gradeResponse = await fetch(`/grade?id=${id}`, {
        method: "GET",
      }).then(res => res.json())
      console.log(gradeResponse)

      document.getElementById("user_grade_name_blank").innerText = gradeResponse.gradeTitle;
      document.getElementById("user_grade").classList.add(`g${gradeResponse.grade}`);

      document.getElementById("user_id_blank").innerText = id;
      document.getElementById("user_hobby_blank").innerText = userResponse.value.hobbyId;
      document.getElementById("user_hobby_content_blank").innerText = userResponse.value.hobbyContent;

      const submitted_id = await JSON.parse(localStorage.getItem("submitted_previous"))?.id;
      if (submitted_id) {
        localStorage.removeItem("submitted_previous")
        const notificationBanner = document.createElement("div");
        notificationBanner.classList.add("notification");
        notificationBanner.addEventListener("click", ()=>{
          notificationBanner.classList.add("close")
        })
        notificationBanner.addEventListener("click", ()=>{
          setTimeout(()=>{
            notificationBanner.remove()
          }, 500)
        })
        notificationBanner.innerHTML = `
        <p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="#b88c07" d="M224 0c-17.7 0-32 14.3-32 32l0 19.2C119 66 64 130.6 64 208l0 18.8c0 47-17.3 92.4-48.5 127.6l-7.4 8.3c-8.4 9.4-10.4 22.9-5.3 34.4S19.4 416 32 416l384 0c12.6 0 24-7.4 29.2-18.9s3.1-25-5.3-34.4l-7.4-8.3C401.3 319.2 384 273.9 384 226.8l0-18.8c0-77.4-55-142-128-156.8L256 32c0-17.7-14.3-32-32-32zm45.3 493.3c12-12 18.7-28.3 18.7-45.3l-64 0-64 0c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7z"/></svg>
          送信先のプロフィールを表示しています</p>
        `;
        document.getElementById("notification").appendChild(notificationBanner);
      }
    }

    fetch("/components/header.html")
      .then((response) => response.text())
      .then((data) => document.querySelector("#header").innerHTML = data);
    fetch("/components/footer.html")
      .then((response) => response.text())
      .then((data) => document.querySelector("#footer").innerHTML = data);

    // リストを表示する関数
    function displayList(fruits) {
      //const fruits = ['りんご', 'バナナ', 'オレンジ', 'ぶどう', 'メロン'];

      const list = document.getElementById('show_SPoints');
      //console.log(fruits.message);
      fruits.forEach(fruit => {
        //console.log("くだもの名 " + fruit);
        const div = document.createElement('div');
        div.classList.add("swiper-slide")
        div.innerHTML = `
        <p>${fruit.value.mainText}</p>
        <div class="datebox">
          ${formatDateTime(String(fruit.value.time))}
        </div>
        <div class=leaf_over>
          <svg id="svg_x5F_leaf" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            viewBox="0 0 747.35 877.82">
          <path class="svg_x5F_leaf_path"
            d="M0,873.85c1.36.25,19.03,3.97,49.48,3.97,18.09,0,39.61-1.31,62.51-5.45,36.32-6.57,68.51-18.93,95.68-36.74,33.9-22.23,59.92-52.96,77.38-91.35,87.24,48.42,186.2,13.76,202.67,7.99,164.25-57.55,218.73-252.15,237.35-318.69,54.46-194.56-4.33-363.59-33.76-433.58,7.19,58.78-103.84,112.64-207.37,166.96-103.53,54.32-273.61,83.83-306.88,281.09-15.62,92.62,2.35,210.16,76.69,274.37,18.08-152.57,202.81-316.97,202.81-316.97,0,0-112.46,168.42-186.14,329.81l-3.04,6.64c-29.76,61.72-82.85,99.94-157.92,113.64-58.45,10.67-108.96,1.67-109.46,1.58v16.73Z" />
          </svg>
        </div>`;
        list.appendChild(div);
      });
    }

    function formatDateTime(dateTimeString) {
      // 文字列から年、月、日、時、分を抽出
      const year = dateTimeString.substring(0, 4);
      const month = dateTimeString.substring(4, 6);
      const day = dateTimeString.substring(6, 8);
      const hour = dateTimeString.substring(8, 10);
      const minute = dateTimeString.substring(10, 12);

      // フォーマットされた文字列を返す
      return `${year}年${parseInt(month)}月${parseInt(day)}日${hour}時${minute}分`;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <!-- Initialize Swiper -->
  <script>
  </script>
  <script src="/lib/footerLinkModifier.js"></script>
</body>

</html>