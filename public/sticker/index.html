<!DOCTYPE html>
<html lang="ja">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/styles/components.css">
  <link rel="stylesheet" href="/styles/quest.css">
  <link rel="manifest" href="manifest.json">
  <title>ステッカー初期型</title>
  <script src="/lib/sessionChecker.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <div id="header"></div>
  <!--- 送信用フォーム --->
  <main>
    <input id="buy_itemName">購入するアイテムのIDを入力してください。</input>
    <p></p>
    <input inputmode="numeric" autocomplete="off" type="number" id="moveitem_index">移動するアイテムのインデックスを入力してください。</input>
    <p></p>
    <input inputmode="numeric" autocomplete="off" type="number" id="buy_itemName_x">購入するアイテムのx座標(0~1)を入力してください。</input>
    <p></p>
    <input inputmode="numeric" autocomplete="off" type="number" id="buy_itemName_y">購入するアイテムのy座標(0~1)を入力してください。</input>
    <p></p>
    <button id="buy_sticker">ステッカー購入</button>
    <button id="check_sticker">ステッカー確認</button>
    <button id="move_sticker">ステッカー移動</button>
    <p id="test">購入状況が表示されます。</p>
    <lu id="itemList">
      <li>test</li>
    </lu>
  </main>

  <div id="footer"></div>

  <script>
    document.getElementById("buy_sticker").onclick = async () => {
      //ローカルストレージ
      const myData = await localStorage.getItem('current_user');
      const ID = Number(JSON.parse(myData).id);//自身のID取得
      const itemName = document.querySelector("#buy_itemName").value;//買うアイテムの名前を取得
      const xPosition = document.querySelector("#buy_itemName_x").value;
      const yPosition = document.querySelector("#buy_itemName_y").value;
      const response = await fetch("/buy_sticker", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ID,
          itemName,
          xPosition,
          yPosition
        })
      });
      document.querySelector("#test").innerHTML = await response.text();
    }
    document.getElementById("check_sticker").onclick = async () => {
      //ローカルストレージ
      const myData = await localStorage.getItem('current_user');
      const ID = Number(JSON.parse(myData).id);//自身のID取得
      const response = await fetch(`/get_mySticker?id=${ID}`, {
        method: "GET",
      });

      const itemList = await response.json();//await JSON.parse(
      //console.log(await stringToArrayOfJSON(itemList));
      //リスト表示
      const list = document.getElementById('itemList');
      removeAllListItems(list);
      let index = 0;
      itemList.forEach(item => {
        //console.log("くだもの名 " + fruit);
        const li = document.createElement('li');
        li.innerHTML = `${JSON.stringify(item)} index = ${index}`;
        list.appendChild(li);
        index++;
      });
    }
    document.getElementById("move_sticker").onclick = async () => {
      //ローカルストレージ
      const myData = await localStorage.getItem('current_user');
      const ID = Number(JSON.parse(myData).id);//自身のID取得
      const itemindex = document.querySelector("#moveitem_index").value;//アイテムを移動するときのインデックス
      const xPosition = document.querySelector("#buy_itemName_x").value;
      const yPosition = document.querySelector("#buy_itemName_y").value;
      console.log(xPosition);
      const response = await fetch("/move_mySticker", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ID,
          itemindex,
          xPosition,
          yPosition
        })
      });
      document.querySelector("#test").innerHTML = await response.text();
    }

    //liをすべて削除
    function removeAllListItems(ul) {
      while (ul.firstChild) {
        if (ul.firstChild.tagName === 'LI') {
          ul.removeChild(ul.firstChild);
        } else {
          ul.firstChild.remove();
        }
      }
    }
  </script>

  <script>
    fetch("/components/header.html")
      .then((response) => response.text())
      .then((data) => document.querySelector("#header").innerHTML = data);
    fetch("/components/footer.html")
      .then((response) => response.text())
      .then((data) => document.querySelector("#footer").innerHTML = data);
  </script>
  <script src="/permission.js"></script>
</body>

</html>