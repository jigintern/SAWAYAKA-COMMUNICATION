<!DOCTYPE html>
<html lang="ja">

<head>
  <script src="/lib/metaPlacer.js"></script>
  <script>
    metaPlacer("ステッカーショップ")
  </script>
  <link rel="stylesheet" href="/styles/shop.css">
  <script src="/lib/sessionChecker.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <div id="header"></div>
  <!--- 送信用フォーム --->
  <main>
    <div class="main_form">
      <h1>バナーを編集</h1>
      <div class="pos_box">
        <div>対象のID
          <input inputmode="numeric" autocomplete="off" type="number" id="moveitem_index">
        </div>
        <div>X(0~100)&nbsp;[%]<input inputmode="numeric" autocomplete="off" type="number" id="buy_itemName_x"></div>
        <div>Y(0~100)&nbsp;[%]<input inputmode="numeric" autocomplete="off" type="number" id="buy_itemName_y"></div>
      </div>
      <button id="check_sticker">ステッカー確認</button>
      <button id="move_sticker">ステッカー移動</button>
      <p id="test">購入状況が表示されます。</p>
      <div class="itemList" id="itemList">
        
      </div>
    </div>
  </main>

  <div id="footer"></div>

  <script>

    window.onload = async (event) => {
      const shopResponse = await fetch(`/shopitems`, {
        method: "GET",
      });

      const shopItems = (await shopResponse.json()).sticker;//await JSON.parse(

      console.log(shopItems)

      //ローカルストレージ
      const myData = await localStorage.getItem('current_user');
      const ID = Number(JSON.parse(myData).id);//自身のID取得
      const response = await fetch(`/get_mySticker?id=${ID}`, {
        method: "GET",
      });

      const itemList = await response.json();
      console.log(itemList)//await JSON.parse(
      //console.log(await stringToArrayOfJSON(itemList));
      //リスト表示
      const list = document.getElementById('itemList');
      removeAllListItems(list);
      let index = 0;
      itemList.forEach(item => {
        //console.log("くだもの名 " + fruit);
        const itemName = item.itemName;
        const X = item.X;
        const Y = item.Y;
        const div = document.createElement('div');
        div.classList.add("item");
        div.innerHTML = `
          <p><b>${itemName}</b></p>
          <img src=${shopItems[itemName].link}>
          <div class="item_cost">
            <span id="point_icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48L48 64zM0 176L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-208L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"/></svg>
            </span>
            X: ${X} Y: ${X}
          </div>
          `;
        list.appendChild(div);
        index++;
      });
      
    }
    

    document.getElementById("check_sticker").onclick = async () => {
      //ローカルストレージ
      const myData = await localStorage.getItem('current_user');
      const ID = Number(JSON.parse(myData).id);//自身のID取得
      const response = await fetch(`/get_mySticker?id=${ID}`, {
        method: "GET",
      });

      const itemList = await response.json();//await JSON.parse(
      //console.log(await stringToArrayOfJSON(itemList));
      //リスト表示
      const list = document.getElementById('itemList');
      removeAllListItems(list);
      let index = 0;
      itemList.forEach(item => {
        //console.log("くだもの名 " + fruit);
        const li = document.createElement('li');
        li.innerHTML = `${JSON.stringify(item)} index = ${index}`;
        list.appendChild(li);
        index++;
      });
      
    }
    document.getElementById("move_sticker").onclick = async () => {
      //ローカルストレージ
      const myData = await localStorage.getItem('current_user');
      const ID = Number(JSON.parse(myData).id);//自身のID取得
      const itemindex = document.querySelector("#moveitem_index").value;//アイテムを移動するときのインデックス
      const xPosition = document.querySelector("#buy_itemName_x").value;
      const yPosition = document.querySelector("#buy_itemName_y").value;
      console.log(xPosition);
      const response = await fetch("/move_mySticker", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ID,
          itemindex,
          xPosition,
          yPosition
        })
      });
      document.querySelector("#test").innerHTML = await response.text();
    }

    //liをすべて削除
    function removeAllListItems(ul) {
      while (ul.firstChild) {
        if (ul.firstChild.tagName === 'LI') {
          ul.removeChild(ul.firstChild);
        } else {
          ul.firstChild.remove();
        }
      }
    }
  </script>

  <script>
    fetch("/components/header.html")
      .then((response) => response.text())
      .then((data) => document.querySelector("#header").innerHTML = data);
    fetch("/components/footer.html")
      .then((response) => response.text())
      .then((data) => document.querySelector("#footer").innerHTML = data);
  </script>
  <script src="/permission.js"></script>
</body>

</html>